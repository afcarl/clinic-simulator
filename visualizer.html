<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<style>
html { box-sizing: border-box; }
*, *:before, *:after { box-sizing: inherit; }
body { font-size: 12px; }
#chart { position: relative; overflow-x: scroll; }
#labels { position: absolute; left: 40px; height: 100%; font-size: 12px; }
#labels div { position:absolute; font-size: 12px; width: 35px; padding-left: 5px; border-left: 1px solid rgba(0,0,0,0.1); height: 100%; }
#legend { margin-bottom: 10px; }
#legend span.event { display: inline-block; width: 15px; height: 15px; vertical-align: text-bottom;}
#legend span.label { display: inline-block; margin-left: 5px; font-size: 10px; line-height: 15px; height: 15px; }
.timeline-group { margin-top: 15px; }

.timeline { position: relative; height: 15px;}
.timeline.odd { }

#atp .timeline     { background: rgba(0,192,0,0.03); }
#atp .timeline.odd { background: rgba(0,192,0,0.06); }
#ct .timeline     { background: rgba(0,0,192,0.03); }
#ct .timeline.odd { background: rgba(0,0,192,0.06); }
#pt .timeline     { background: rgba(192,0,0,0.03); }
#pt .timeline.odd { background: rgba(192,0,0,0.06); }

.timeline div.label { height: 15px; line-height: 15px; font-size: 10px; width: 40px; }
.timeline .event { opacity: 0.9; position: absolute; top: 0; font-size: 10px; line-height: 15px; height: 15px; border-radius: 2px; background: #ccc; text-align: center; border: 1px solid #fff; box-shadow: inset 0 0 1px #000; border-bottom: 0; border-right: 0; color: rgba(0,0,0,0.5); }

p { margin-bottom: 5px; }

#params { }
#params fieldset { width: 33%; display: inline-block; vertical-align: top; margin: 0; border: 0;}
#params fieldset legend { margin:0; padding:0; font-weight: bold; }
#distributions { }
.form-control {display: block; height: 20px; }
.form-control label { display: inline-block; width: 8em; }
.distribution label { width: auto; text-align: right; padding: 0 5px; }
.distribution label:first-of-type { width: 8em; text-align: left; padding: 0; }

.event.ct_atp_meeting { background: #b6b; }
.event.pt_meeting { background: #6c6; }
.event.ct_pt_meeting { background: #6bb; }
.event.ct_atp_meeting { background: ; }
.event.waiting_for_atp { background: #f66; }
.event.waiting_for_ct { background: #fa6; }
.event.checking_in { background: #eee; }
.event.checking_out { background: #eee; }

.histograms img { display: inline-block; width: 25%; }
#plots .params { }
</style>
<form id="params">
<fieldset id="simulation"><legend>Simulation</legend>
<div class="form-control"><label># patients</label>
<input type="text" name="n_pt" value="12" size="3" /></div>
<div class="form-control"><label># attending</label>
<input type="text" name="n_atp" value="2"  size="3" /></div>
<div class="form-control"><label># clinical teams</label>
<input type="text" name="n_ct" value="4" size="3" /></div>
<div id="summary"></div>
</fieldset>
<fieldset id="distributions">
  <legend>Distributions</legend>
</fieldset>
<fieldset id="scheduler"><legend>Scheduler</legend>
<div class="form-control"><label>group size</label>
<input type="text" name="group_size" value="3" size="3" /></div>
<div class="form-control"><label>spacing (minutes)</label>
<input type="text" name="spacing" value="15" size="3" /></div>
<div class="form-control"><button id="btn_get_sample">Get Sample</button>
<button id="btn_do_mc">Run Monte Carlo</button></div>
<div id="schedule"></div>
</fieldset>
</form>
<div id="legend">
<span class="event checking_in"></span><span class="label">Check-in</span>
<span class="event waiting_for_ct"></span><span class="label">Waiting for CT</span>
<span class="event ct_pt_meeting"></span><span class="label">PT/CT meeting</span>
<span class="event ct_atp_meeting"></span><span class="label">CT/ATP meeting</span>
<span class="event waiting_for_atp"></span><span class="label">Wating for ATP</span>
<span class="event pt_meeting"></span><span class="label">PT/ATP meeting</span>
<span class="event checking_out"></span><span class="label">Check-out</span>
</div>
<div id="plots"></div>
<div id="chart"></div>

<script>

var default_distributions = [
  {'name': 'arrival_delay',  'min':  0, 'max':  60, 'mean': 10, 'type': 'pois'},
  {'name': 'checkin',        'min':  2, 'max':  10, 'mean':  5, 'type': 'pois'},
  {'name': 'ct_round',       'min': 10, 'max':  60, 'mean': 25, 'type': 'pois'},
  {'name': 'ct_atp_meeting', 'min':  2, 'max':   8, 'mean':  4, 'type': 'pois'},
  {'name': 'atp_round',      'min': 12, 'max':  18, 'mean': 15, 'type': 'pois'},
  {'name': 'checkout',       'min':  2, 'max':  10, 'mean':  5, 'type': 'pois'}
];

var dist_fields = ['min', 'max', 'mean']
for (var i in default_distributions) {
  var dist = default_distributions[i];
  var distDiv = document.createElement('div');
  distDiv.className = 'distribution form-control';
  var label = document.createElement('label');
  label.appendChild(document.createTextNode(dist.name));
  label.className = 'dist-label';
  distDiv.appendChild(label);
  for (var j in dist_fields) {
    var label = document.createElement('label');
    label.appendChild(document.createTextNode(dist_fields[j]));
    distDiv.appendChild(label);
    var input = document.createElement('input');
    input.setAttribute('type', 'text');
    input.setAttribute('name', dist.name + '_' + dist_fields[j]);
    input.setAttribute('value', dist[dist_fields[j]]);
    input.setAttribute('size', 3);
    distDiv.appendChild(input);
  }
  document.getElementById('distributions').appendChild(distDiv);
}


var label_offset = 40;
var scale = 7; // px per minute

$("#btn_get_sample").click(function(event) {
  event.preventDefault();
  $.post('/', $('#params').serialize(), function(response) {
    console.log(response);
    visualize_data(response);
  }, 'json');
});

$("#btn_do_mc").click(function(event) {
  event.preventDefault();
  var params = $('#params').serialize();
  var paramsDiv = document.createElement('div');
  paramsDiv.className = 'params';
  paramsDiv.appendChild(document.createTextNode(params.split("&").join(', ')));
  document.getElementById('plots').appendChild(paramsDiv);
  $.post('/mc', params, function(response) {
    console.log(response);
    var div = document.createElement('div');
    div.className = 'histograms';
    for (var i in response) {
      var img = document.createElement('img');
      img.setAttribute('src', 'data:image/png;base64,' + response[i]);
      div.appendChild(img);
    }
    document.getElementById('plots').appendChild(div);
  }, 'json');
});

function visualize_data(data) {

  document.getElementById('chart').innerHTML = '<div id="labels"></div>\
    <div class="timeline-group" id="atp"></div>\
    <div class="timeline-group" id="ct"></div>\
    <div class="timeline-group" id="pt"></div>';

  // create timeline labels
  for (var i = 0; i < data.end_time; i+= 5) {
    var label = document.createElement('div');
    min = (i % 60);
    if (min < 10) min = '0' + min;
    labelText = Math.floor(i / 60) + 5 + ":" + min;
    label.appendChild(document.createTextNode(labelText));
    label.style.left = (i * scale) + 'px';
    document.getElementById('labels').appendChild(label);
  }

  function create_event(className, time, duration) {
    var eventDiv = document.createElement('div');
    eventDiv.appendChild(document.createTextNode(duration|0));
    eventDiv.className = 'event ' + className;
    eventDiv.style.left = label_offset + time * scale + 'px';
    eventDiv.style.width = duration * scale + 'px';
    return eventDiv;
  }

  function create_timeline(labelText) {
    var timeline = document.createElement('div');
    timeline.className = 'timeline';
    var label = document.createElement('div');
    label.appendChild(document.createTextNode(labelText));
    label.className = 'label';
    timeline.appendChild(label);
    return timeline;
  }

  // create ATP events
  for (var i in data.atp_data) {
    var atp = data.atp_data[i];
    var ct_atp_begin = 0, pt_begin = 0;
    var timeline = create_timeline(atp.id);
    if (i % 2 == 0) timeline.className += ' odd';
    for (var j in atp.events) {
      var event = atp.events[j];
      if (event.name == 'begin_ct_atp_meeting')
        ct_atp_begin = event.time;
      if (event.name == 'end_ct_atp_meeting')
        timeline.appendChild(create_event('ct_atp_meeting', ct_atp_begin, event.time - ct_atp_begin));
      if (event.name == 'begin_meeting_with_patient')
        pt_begin = event.time;
      if (event.name == 'end_meeting_with_patient')
        timeline.appendChild(create_event('pt_meeting', pt_begin, event.time - pt_begin));
    }
    document.getElementById('atp').appendChild(timeline);
  }

  // create CT events
  for (var i in data.ct_data) {
    var ct = data.ct_data[i];
    var wait_atp_begin = 0, ct_atp_begin = 0, pt_begin = 0;
    var timeline = create_timeline(ct.id);
    if (i % 2 == 0) timeline.className += ' odd';
    for (var j in ct.events) {
      var event = ct.events[j];
      if (event.name == 'begin_meeting_with_patient')
        pt_begin = event.time;
      if (event.name == 'end_meeting_with_patient')
        timeline.appendChild(create_event('ct_pt_meeting', pt_begin, event.time - pt_begin));
      if (event.name == 'begin_ct_atp_meeting')
        ct_atp_begin = event.time;
      if (event.name == 'end_ct_atp_meeting')
        timeline.appendChild(create_event('ct_atp_meeting', ct_atp_begin, event.time - ct_atp_begin));
      if (event.name == 'begin_waiting_for_atp')
        wait_atp_begin = event.time;
      if (event.name == 'end_waiting_for_atp')
        timeline.appendChild(create_event('waiting_for_atp', wait_atp_begin, event.time - wait_atp_begin));
    }
    document.getElementById('ct').appendChild(timeline);
  }

  // create PT events
  for (var i in data.pt_data) {
    var pt = data.pt_data[i];
    var checkin_begin = 0, checkout_begin = 0, ct_wait_begin = 0, ct_meet_begin = 0, atp_wait_begin = 0, atp_meet_begin;
    var timeline = create_timeline(pt.id);
    if (i % 2 == 0) timeline.className += ' odd';
    for (var j in pt.events) {
      var event = pt.events[j];
      if (event.name == 'begin_checking_in')
        checkin_begin = event.time;
      if (event.name == 'end_checking_in')
        timeline.appendChild(create_event('checking_in', checkin_begin, event.time - checkin_begin));
      if (event.name == 'begin_waiting_for_ct')
        ct_wait_begin = event.time;
      if (event.name == 'end_waiting_for_ct')
        timeline.appendChild(create_event('waiting_for_ct', ct_wait_begin, event.time - ct_wait_begin));
      if (event.name == 'begin_meeting_with_ct')
        ct_meet_begin = event.time;
      if (event.name == 'end_meeting_with_ct')
        timeline.appendChild(create_event('ct_pt_meeting', ct_meet_begin, event.time - ct_meet_begin));
      if (event.name == 'begin_waiting_for_atp')
        atp_wait_begin = event.time;
      if (event.name == 'end_waiting_for_atp')
        timeline.appendChild(create_event('waiting_for_atp', atp_wait_begin, event.time - atp_wait_begin));
      if (event.name == 'begin_meeting_with_atp')
        atp_meet_begin = event.time;
      if (event.name == 'end_meeting_with_atp')
        timeline.appendChild(create_event('pt_meeting', atp_meet_begin, event.time - atp_meet_begin));
      if (event.name == 'begin_checking_out')
        checkout_begin = event.time;
      if (event.name == 'end_checking_out')
        timeline.appendChild(create_event('checking_out', checkout_begin, event.time - checkout_begin));
    }
    document.getElementById('pt').appendChild(timeline);

    document.getElementById('summary').innerHTML = '<p><strong>Averages</strong></p>' +
      'Waiting for attending: ' + data.summary.pt_wait_atp_mean.toFixed(1) + ' minutes<br />' +
      'Waiting room time: ' + data.summary.pt_wait_ct_mean.toFixed(1) + ' minutes';

    document.getElementById('schedule').innerHTML = '<p><strong>Schedule</strong></p>' +
      '' + data.params.schedule.join(', ');


  }

}
</script>
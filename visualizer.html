<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<style>
html { box-sizing: border-box; }
*, *:before, *:after { box-sizing: inherit; }
#chart { position: relative; overflow-x: scroll; }
#labels { position: absolute; left: 40px; height: 100%; font-size: 12px; }
#labels div { position:absolute; font-size: 12px; width: 35px; padding-left: 5px; border-left: 1px solid rgba(0,0,0,0.1); height: 100%; }
#legend { margin-bottom: 10px; }
#legend span.event { display: inline-block; width: 15px; height: 15px; vertical-align: text-bottom;}
#legend span.label { display: inline-block; margin-left: 5px; font-size: 10px; line-height: 15px; height: 15px; }
.timeline-group { margin-top: 15px; }
.timeline { position: relative; height: 15px; background: rgba(0,0,0,0.03); }
.timeline.odd { background: rgba(0,0,0,0.06); }
.timeline div.label { height: 15px; line-height: 15px; font-size: 10px; width: 40px; }
.timeline .event { opacity: 0.9; position: absolute; top: 0; font-size: 10px; line-height: 15px; height: 15px; border-radius: 2px; background: #ccc; text-align: center; border: 1px solid #fff; box-shadow: inset 0 0 1px #000; border-bottom: 0; border-right: 0; color: rgba(0,0,0,0.5); }
.event.ct_atp_meeting { background: #b6b; }
.event.pt_meeting { background: #6c6; }
.event.ct_pt_meeting { background: #6bb; }
.event.ct_atp_meeting { background: ; }
.event.waiting_for_atp { background: #f66; }
.event.waiting_for_ct { background: #fa6; }
.event.checking_in { background: #eee; }
.event.checking_out { background: #eee; }
</style>
<form id="params">
<fieldset>
<label># patients</label>
<input type="text" name="n_pt" value="12" />
<label># attending physicians</label>
<input type="text" name="n_atp" value="2"  />
<label># clinical teams</label>
<input type="text" name="n_ct" value="4"  />
</fieldset>
<fieldset><legend>Scheduler options</legend>
<label>patient group size</label>
<input type="text" name="group_size" value="3" />
<label>group spacing (minutes)</label>
<input type="text" name="spacing" value="15" />
<input type="submit" />
</fieldset>
</form>
<div id="legend">
<span class="event checking_in"></span><span class="label">Check-in</span>
<span class="event waiting_for_ct"></span><span class="label">Waiting for CT</span>
<span class="event ct_pt_meeting"></span><span class="label">PT/CT meeting</span>
<span class="event ct_atp_meeting"></span><span class="label">CT/ATP meeting</span>
<span class="event waiting_for_atp"></span><span class="label">Wating for ATP</span>
<span class="event pt_meeting"></span><span class="label">PT/ATP meeting</span>
<span class="event checking_out"></span><span class="label">Check-out</span>
</div>
<div id="chart"></div>

<script>
var label_offset = 40;
var scale = 7; // px per minute
var action = 'http://localhost:8888/';

$("#params").submit(function(event) {
  event.preventDefault();
  $.post(action, $(this).serialize(), function(response) {
    console.log(response);
    visualize_data(response);
  }, 'json');
});

function visualize_data(data) {

  document.getElementById('chart').innerHTML = '<div id="labels"></div>\
    <div class="timeline-group" id="atp"></div>\
    <div class="timeline-group" id="ct"></div>\
    <div class="timeline-group" id="pt"></div>';

  // create timeline labels
  for (var i = 0; i < data.end_time; i+= 5) {
    var label = document.createElement('div');
    min = (i % 60);
    if (min < 10) min = '0' + min;
    labelText = Math.floor(i / 60) + 5 + ":" + min;
    label.appendChild(document.createTextNode(labelText));
    label.style.left = (i * scale) + 'px';
    document.getElementById('labels').appendChild(label);
  }

  function create_event(className, time, duration) {
    var eventDiv = document.createElement('div');
    eventDiv.appendChild(document.createTextNode(duration|0));
    eventDiv.className = 'event ' + className;
    eventDiv.style.left = label_offset + time * scale + 'px';
    eventDiv.style.width = duration * scale + 'px';
    return eventDiv;
  }

  function create_timeline(labelText) {
    var timeline = document.createElement('div');
    timeline.className = 'timeline';
    var label = document.createElement('div');
    label.appendChild(document.createTextNode(labelText));
    label.className = 'label';
    timeline.appendChild(label);
    return timeline;
  }

  // create ATP events
  for (var i in data.atp_data) {
    var atp = data.atp_data[i];
    var ct_atp_begin = 0, pt_begin = 0;
    var timeline = create_timeline(atp.id);
    if (i % 2 == 0) timeline.className += ' odd';
    for (var j in atp.events) {
      var event = atp.events[j];
      if (event.name == 'begin_ct_atp_meeting')
        ct_atp_begin = event.time;
      if (event.name == 'end_ct_atp_meeting')
        timeline.appendChild(create_event('ct_atp_meeting', ct_atp_begin, event.time - ct_atp_begin));
      if (event.name == 'begin_meeting_with_patient')
        pt_begin = event.time;
      if (event.name == 'end_meeting_with_patient')
        timeline.appendChild(create_event('pt_meeting', pt_begin, event.time - pt_begin));
    }
    document.getElementById('atp').appendChild(timeline);
  }

  // create CT events
  for (var i in data.ct_data) {
    var ct = data.ct_data[i];
    var wait_atp_begin = 0, ct_atp_begin = 0, pt_begin = 0;
    var timeline = create_timeline(ct.id);
    if (i % 2 == 0) timeline.className += ' odd';
    for (var j in ct.events) {
      var event = ct.events[j];
      if (event.name == 'begin_meeting_with_patient')
        pt_begin = event.time;
      if (event.name == 'end_meeting_with_patient')
        timeline.appendChild(create_event('ct_pt_meeting', pt_begin, event.time - pt_begin));
      if (event.name == 'begin_ct_atp_meeting')
        ct_atp_begin = event.time;
      if (event.name == 'end_ct_atp_meeting')
        timeline.appendChild(create_event('ct_atp_meeting', ct_atp_begin, event.time - ct_atp_begin));
      if (event.name == 'begin_waiting_for_atp')
        wait_atp_begin = event.time;
      if (event.name == 'end_waiting_for_atp')
        timeline.appendChild(create_event('waiting_for_atp', wait_atp_begin, event.time - wait_atp_begin));
    }
    document.getElementById('ct').appendChild(timeline);
  }

  // create PT events
  for (var i in data.pt_data) {
    var pt = data.pt_data[i];
    var checkin_begin = 0, checkout_begin = 0, ct_wait_begin = 0, ct_meet_begin = 0, atp_wait_begin = 0, atp_meet_begin;
    var timeline = create_timeline(pt.id);
    if (i % 2 == 0) timeline.className += ' odd';
    for (var j in pt.events) {
      var event = pt.events[j];
      if (event.name == 'begin_checking_in')
        checkin_begin = event.time;
      if (event.name == 'end_checking_in')
        timeline.appendChild(create_event('checking_in', checkin_begin, event.time - checkin_begin));
      if (event.name == 'begin_waiting_for_ct')
        ct_wait_begin = event.time;
      if (event.name == 'end_waiting_for_ct')
        timeline.appendChild(create_event('waiting_for_ct', ct_wait_begin, event.time - ct_wait_begin));
      if (event.name == 'begin_meeting_with_ct')
        ct_meet_begin = event.time;
      if (event.name == 'end_meeting_with_ct')
        timeline.appendChild(create_event('ct_pt_meeting', ct_meet_begin, event.time - ct_meet_begin));
      if (event.name == 'begin_waiting_for_atp')
        atp_wait_begin = event.time;
      if (event.name == 'end_waiting_for_atp')
        timeline.appendChild(create_event('waiting_for_atp', atp_wait_begin, event.time - atp_wait_begin));
      if (event.name == 'begin_meeting_with_atp')
        atp_meet_begin = event.time;
      if (event.name == 'end_meeting_with_atp')
        timeline.appendChild(create_event('pt_meeting', atp_meet_begin, event.time - atp_meet_begin));
      if (event.name == 'begin_checking_out')
        checkout_begin = event.time;
      if (event.name == 'end_checking_out')
        timeline.appendChild(create_event('checking_out', checkout_begin, event.time - checkout_begin));
    }
    document.getElementById('pt').appendChild(timeline);
  }

}
</script>